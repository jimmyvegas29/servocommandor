#:kivy 2.3.1
#:import Graph kivy_garden.graph.Graph
#:import MeshLinePlot kivy_garden.graph.MeshLinePlot
#:import LongPressButton main.LongPressButton

<ServoLabel@Label>:
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '24sp'

<ServoButton@Button>:
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    canvas.before:
        Color:
            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]

<EnableButton@LongPressButton>:
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    canvas.before:
        Color:
            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]

<ServoButtonNRad@Button>: #No Radius
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    canvas.before:
        Color:
            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [(0, 0), (0), (0), (0, 0)]

<ServoButtonRRad@Button>: #Right Radius
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    canvas.before:
        Color:
            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [(0, 0), (7.0, 7.0), (7.0, 7.0), (0, 0)]

<ServoButtonLRad@Button>: #Left Radius
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    border_radius: (10,10,10,10)
    canvas.before:
        Color:
            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [(7.0, 7.0), (0, 0), (0, 0), (7.0, 7.0)]

<ServoTButtonRRad@ToggleButton>: #Right Radius Toggle Button
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    background_down: ''
    state: 'down'

<ServoTButtonLRad@ToggleButton>: #Left Radius Toggle Button
    font_name: 'assets/Orbitron-Medium.ttf'
    font_size: '44sp'
    background_color: (100.3, 110.3, 0.3, 0)
    background_normal: ''
    background_down: ''
    state: 'down'

<NumberPadPopup@ModalView>:
    size_hint: (1, 1)
    background_color: (0.1, 0.1, 0.1, 1)
    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        Label:
            id: numpad_display
            text: ''
            font_name: 'assets/Orbitron-Medium.ttf'
            font_size: '80sp'
            size_hint_y: None
            height: '125dp'
            halign: 'center'
            valign: 'middle'
        GridLayout:
            cols: 3
            rows: 4
            spacing: 5
            padding: [50,0,50,0]
            ServoButton:
                text: '7'
                on_press: root.add_digit('7')
            ServoButton:
                text: '8'
                on_press: root.add_digit('8')
            ServoButton:
                text: '9'
                on_press: root.add_digit('9')
            ServoButton:
                text: '4'
                on_press: root.add_digit('4')
            ServoButton:
                text: '5'
                on_press: root.add_digit('5')
            ServoButton:
                text: '6'
                on_press: root.add_digit('6')
            ServoButton:
                text: '1'
                on_press: root.add_digit('1')
            ServoButton:
                text: '2'
                on_press: root.add_digit('2')
            ServoButton:
                text: '3'
                on_press: root.add_digit('3')
            ServoButton:
                text: 'Clear'
                on_press: root.clear_display()
            ServoButton:
                text: '0'
                on_press: root.add_digit('0')
            ServoButton:
                text: 'Delete'
                on_press: root.delete_digit()
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: '64dp'
            spacing: 10
            padding: [100,0,100,10]
            ServoButton:
                text: 'Exit'
                on_press: root.dismiss()
            ServoButton:
                text: 'Set'
                on_press: root.submit_value()

<OfflinePopup@ModalView>:
    size_hint: (1, 1)
    background_color: (0.1, 0.1, 0.1, 0.8)
    overlay_color: (0.1, 0.1, 0.1, 0)
    BoxLayout:
        orientation: 'vertical'
        size_hint: (0.6, 0.3)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        padding: 10
        canvas:
            Color: 
                rgb: 0.16, 0.16, 0.16
            RoundedRectangle:
                size: self.size
                pos: self.pos
                radius: [(7.0, 7.0), (7.0, 7.0), (0, 0), (0, 0)]
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: (0.35)
            canvas:
                Color: 
                    rgb: 0.16, 0.16, 0.16
                RoundedRectangle:
                    size: self.size
                    pos: self.pos
            Label:
                id: offline_display
                text: 'DRIVE OFFLINE'
                font_name: 'assets/Orbitron-Medium.ttf'
                font_size: '48sp'
                on_size: self.text_size = self.size
                halign: 'center'
                valign: 'middle'
        BoxLayout:
            size_hint_y: (0.25)
            orientation: 'vertical'
            canvas:
                Color: 
                    rgb: 0.16, 0.16, 0.16
                RoundedRectangle:
                    size: self.size
                    pos: self.pos
            Label:
                id: offline_display
                text: 'Check connection or power'
                font_name: 'assets/Orbitron-Medium.ttf'
                font_size: '16sp'
                on_size: self.text_size = self.size
                halign: 'center'
                valign: 'top'
        BoxLayout:
            size_hint_y: (0.40)
            GridLayout:
                cols: 3
                spacing: 5
                ServoButton:
                    text: 'System Shutdown'
                    text_size: self.size
                    font_size: '12sp'
                    halign: 'center'
                    valign: 'middle'
                    on_press: root.full_shutdown()
                    canvas.before:
                        Color:
                            rgba: (0.105, 0.105, 0.105, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]
                ServoButton:
                    text: 'System Restart'
                    text_size: self.size
                    font_size: '12sp'
                    halign: 'center'
                    valign: 'middle'
                    on_press: root.sys_restart()
                    canvas.before:
                        Color:
                            rgba: (0.105, 0.105, 0.105, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]
                ServoButton:
                    text: 'App Shutdown'
                    text_size: self.size
                    font_size: '12sp'
                    halign: 'center'
                    valign: 'middle'
                    on_press: root.app_close()
                    canvas.before:
                        Color:
                            rgba: (0.105, 0.105, 0.105, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]

<ServoControl>:
    orientation: 'vertical'
    canvas:
        Color:
            rgba: (0.01, 0.01, 0.01, 1)
        Rectangle:
            pos: self.pos
            size: (800.0,480.0)
    
    BoxLayout:
        orientation: "horizontal"
        padding: 10
        spacing: 10
        size_hint_y: (0.46875)
        BoxLayout: #RPM Title Bar and Digits Layout
            orientation: "vertical"
            #padding: 10
            size_hint_x: (0.75)
            BoxLayout: #RPM Title Bar "Servo Speed  RPM"
                size_hint_y: (None)
                height: '53.21dp'
                width: '587.235dp'
                background_color: 0, 0, 25, 0
                #padding: [10,0,0,0]
                #spacing: 5
                canvas:
                    Color: 
                        rgb: 0.16, 0.16, 0.16
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [(7.0, 7.0), (7.0, 7.0), (0, 0), (0, 0)]

                ServoLabel:
                    text: 'Servo Speed'
                    text_size: self.size
                    font_size: '34dp'
                    halign: 'left'
                    valign: 'middle'
                    padding: [10,0,0,5]
                ServoLabel:
                    id: servo_mode
                    text: 'R.P.M.'
                    text_size: self.size
                    font_size: '34dp'
                    halign: 'right'
                    valign: 'middle'
                    padding: [0,0,10,5]

            BoxLayout: #RPM Layout
                id: rpm_layout
                #cols: 4
                size_hint_y: (None)
                height: '151.79dp'
                width: '587.235dp'
                padding: 10
                #spacing: 5
                canvas:
                    Color: 
                        rgb: 0.11, 0.11, 0.11
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [(0, 0), (0, 0), (7.0, 7.0), (7.0, 7.0)]                   
                ServoLabel:
                    id: rpm_digit_1
                    text: '0'
                    text_size: self.size
                    font_size: '170dp'
                    color: (0.13, 0.13, 0.13, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,10]
                ServoLabel:
                    id: rpm_digit_2
                    text: '0'
                    text_size: self.size
                    font_size: '170dp'
                    color: (0.13, 0.13, 0.13, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,10]
                ServoLabel:
                    id: rpm_digit_3
                    text: '0'
                    text_size: self.size
                    font_size: '170dp'
                    color: (0.13, 0.13, 0.13, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,10]
                ServoLabel:
                    id: rpm_digit_4
                    text: '0'
                    #text_size: self.size
                    font_size: '170dp'
                    color: (1, 1, 1, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,10]
        BoxLayout:
            orientation: "vertical"
            #padding: 10
            size_hint_x: (0.25)
            BoxLayout:
                size_hint_y: (None)
                height: '53.21dp'
                width: '180dp'
                background_color: 0, 0, 25, 0
                #padding: [10,0,0,0]
                #spacing: 5
                canvas:
                    Color: 
                        rgb: (0.16, 0.16, 0.16, 1)
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [(7.0, 7.0), (7.0, 7.0), (0, 0), (0, 0)]

                ServoLabel:
                    text: 'Torque %'
                    text_size: self.size
                    font_size: '34dp'
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,10]
            BoxLayout:
                id: torque_layout
                size_hint_y: (None)
                height: '75.895dp'
                width: '180dp'
                #padding: 10
                #spacing: 5
                canvas:
                    Color: 
                        rgba: (0.11, 0.11, 0.11, 1)
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [(0, 0), (0, 0), (0, 0), (0, 0)]                   
                ServoLabel:
                    id: torque_digit_1
                    text: '0'
                    text_size: self.size
                    font_size: '70dp'
                    color: (0.13, 0.13, 0.13, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [5,0,0,5]
                ServoLabel:
                    id: torque_digit_2
                    text: '0'
                    text_size: self.size
                    font_size: '70dp'
                    color: (0.13, 0.13, 0.13, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,0,5]
                ServoLabel:
                    id: torque_digit_3
                    text: '0'
                    text_size: self.size
                    font_size: '70dp'
                    color: (1, 1, 1, 1)
                    halign: 'center'
                    valign: 'middle'
                    padding: [0,0,5,5]
            BoxLayout:
                id: peak_layout
                size_hint_y: (None)
                height: '75.895dp'
                width: '180dp'
                padding: [10,0,0,10]
                #spacing: 5
                canvas.before:
                    Color: 
                        rgba: (0.11, 0.11, 0.11, 1)
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [(0, 0), (0, 0), (7.0, 7.0), (7.0, 7.0)]                   
                Graph:
                    id: torque_graph
                    size_hint: (None, None)
                    width: '174dp'
                    height: '65dp'

                    # --- Graph Axis and Grid Properties ---
                    #xlabel: 'Time'
                    #ylabel: 'Torque'

                    #Set the initial visible range for X and Y axes
                    xmin: 0
                    xmax: 40
                    ymin: -100
                    ymax: 100

                    # Define grid lines and tick marks
                    x_grid: True
                    y_grid: True
                    x_grid_label: False
                    y_grid_label: False
                    padding: 0
                    background_color: (0.16, 0.16, 0.16, 1)
                    border_color: (0.105, 0.105, 0.105, 1)
                    tick_color: (0, 0, 0, 1)
                    x_tick_major: 5
                    y_ticks_major: 10

    BoxLayout:
        size_hint_y: (0.53125)
        padding: 10
        BoxLayout:
            orientation: "vertical"
            size_hint_x: (.6725)
            padding: [0,0,5,0]
            spacing: 5
            GridLayout:
                size_hint_y: (None)
                height: '78.33dp'
                cols: 3
                spacing: 5
                ServoButtonLRad:
                    id: sp_btn1
                    text: '50'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonNRad:
                    id: sp_btn2
                    text: '100'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonRRad:
                    id: sp_btn3
                    text: '200'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
            GridLayout:
                size_hint_y: (None)
                height: '78.33dp'
                cols: 3
                spacing: 5
                ServoButtonLRad:
                    id: sp_btn4
                    text: '400'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonNRad:
                    id: sp_btn5
                    text: '600'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonRRad:
                    id: sp_btn6
                    text: '800'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
            GridLayout:
                size_hint_y: (None)
                height: '78.33dp'
                cols: 3
                spacing: 5
                ServoButtonLRad:
                    id: sp_btn7
                    text: '1000'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonNRad:
                    id: sp_btn8
                    text: '1500'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
                ServoButtonRRad:
                    id: sp_btn9
                    text: '2000'
                    on_press: root.set_speed(int(self.text)) if root.text_integer(self.text) else None
        BoxLayout:
            orientation: "vertical"
            size_hint_x: (.3275)
            padding: [5,0,0,0]
            spacing: 5
            GridLayout:
                size_hint_y: (None)
                height: '78.33dp'
                cols: 2
                spacing: 5
                ServoButtonLRad:
                    id: inc_btnp
                    text: '+50'
                    on_press: root.adjust_speed(int(self.text))
                    canvas.before:
                        Color:
                            rgba: (0.313, 0.313, 0.313, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (0, 0), (0, 0), (7.0, 7.0)]
                ServoButtonRRad:
                    id: inc_btnn
                    text: '-50'
                    on_press: root.adjust_speed(int(self.text))
                    canvas.before:
                        Color:
                            rgba: (0.313, 0.313, 0.313, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(0, 0), (7.0, 7.0), (7.0, 7.0), (0, 0)]
            BoxLayout:
                size_hint_y: (None)
                height: '78.33dp'
                spacing: 5
                ServoButton:
                    size_hint_x: (0.5)
                    text: 'Custom\nSpeed'
                    font_size: '22sp'
                    halign: 'center'
                    valign: 'middle'
                    on_press: root.show_custom_numpad()
                ServoButton:
                    size_hint_x: (0.5)
                    #text: 'C'
                    #font_size: '28sp'
                    #halign: 'center'
                    #valign: 'middle'
                    on_press: root.show_custom_numpad()
                    BoxLayout:
                        size: self.parent.size
                        pos: self.parent.pos
                        orientation: 'horizontal'
                        padding: 5
                        spacing: 5
                        Image:
                            source: app.get_file_path('assets/icon_calc_white.png')
                            allow_stretch: True
            GridLayout:
                id: lb_layout
                size_hint_y: (None)
                height: '78.33dp'
                cols: 2
                spacing: 5
                ServoTButtonLRad:
                    id: fwd_button
                    text: 'FORWARD'
                    color: (0, 0.5, 1, 1) if self.state == 'normal' else (1, 1, 1, 1)
                    font_size: '18sp'
                    on_press: root.toggle_direction('rev') if self.text == 'FORWARD' else root.toggle_direction('fwd')
                    canvas.before:
                        Color:
                            rgba: (0.16, 0.16, 0.16, 1) if self.state == 'normal' else (0, 0.5, 1, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]
                EnableButton:
                    id: servo_button
                    text: 'DISABLED'
                    color: (1, 1, 1, 1) if self.state == 'normal' else (0.313, 0.313, 0.313, 1)
                    font_size: '18sp'
                    on_release: root.toggle_enable('enabled') if self.text == 'DISABLED' else root.toggle_enable('disabled') 
                    canvas.before:
                        Color:
                            rgba: (0, 0.5, 1, 1) if self.text == 'ENABLED' else (0.105, 0.105, 0.105, 1)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [(7.0, 7.0), (7.0, 7.0), (7.0, 7.0), (7.0, 7.0)]
